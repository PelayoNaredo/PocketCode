# Backend Architecture for PocketCode IDE

This document outlines the backend and cloud infrastructure for the PocketCode IDE. The architecture is designed to be serverless, scalable, and secure, offloading heavy computational tasks from the mobile client to the cloud.

## 1. Core Architectural Principles

- **Serverless-First:** All backend components will be deployed on serverless platforms to ensure scalability, reduce operational overhead, and maintain a cost-effective pay-per-use model.
- **Backend for Frontend (BFF):** A dedicated BFF will serve as the single entry point for the mobile client. It will aggregate data from various services and tailor responses specifically for the needs of the frontend, reducing client-side logic.
- **Infrastructure as Code (IaC):** While not detailed here, the cloud infrastructure should ideally be managed using tools like Terraform or Google Cloud Deployment Manager for reproducibility and version control.
- **Security by Design:** Security is paramount. Sensitive credentials like API keys will never be stored on the client. All sensitive operations will be handled by a secure server-side proxy.

## 2. Technology Stack & Services

- **Primary Cloud Provider:** Google Cloud Platform (GCP)
- **Compute:** Google Cloud Run (for BFF and API Proxy)
- **Database:** Cloud Firestore (for user data, project metadata, build logs)
- **File Storage:** Google Cloud Storage (for source code, assets, and build artifacts)
- **Authentication:** Firebase Authentication (for user management)
- **CI/CD Engine:** GitHub Actions (for the remote build pipeline)

## 3. System Components

### a. Backend for Frontend (BFF)
- **Service:** Google Cloud Run
- **Purpose:** To act as the main intermediary between the mobile client and backend services.
- **Responsibilities:**
  - Expose a clean, mobile-optimized REST/GraphQL API.
  - Handle business logic that involves multiple services (e.g., creating a new project entry in Firestore and its corresponding folder in Cloud Storage).
  - Authenticate and authorize all incoming requests from the client using Firebase Auth tokens.

### b. Secure API Proxy
- **Service:** Google Cloud Run
- **Purpose:** To securely manage and use third-party API keys (e.g., for AI services like Gemini).
- **Workflow:**
  1. The mobile client makes a request to the proxy endpoint (e.g., `/proxy/ai/generate`).
  2. The proxy verifies the user's authentication token.
  3. It retrieves the appropriate API key. This could be the platform's key or a user-provided key (for the "Bring Your Own Key" model), which is stored securely in Firestore.
  4. The proxy injects the key into the request and forwards it to the external service (e.g., Google AI Platform).
  5. It can optionally cache responses (e.g., using Redis or Memorystore) to reduce latency and cost.
  6. It returns the response to the client.

### c. CI/CD "Code-to-Cloud" Pipeline
- **Service:** GitHub Actions
- **Purpose:** To compile, sign, and prepare the user's Android project for download.
- **Workflow:**
  1. **Trigger:** The user presses the "Build" button in the IDE. This action pushes the current state of the code to a dedicated, private GitHub repository for that project/user.
  2. **Execution:** A `git push` event triggers a predefined GitHub Actions workflow (`.github/workflows/android-build.yml`).
  3. **Build Steps:**
     - The workflow runs on a GitHub-hosted runner (e.g., `ubuntu-latest`).
     - It checks out the source code.
     - It sets up the correct Java and Android SDK versions.
     - It executes the Gradle build command (e.g., `./gradlew bundleRelease`).
  4. **Signing:**
     - The Android signing key is stored as an encrypted secret in GitHub Secrets.
     - A dedicated action signs the generated AAB/APK.
  5. **Artifact Storage:**
     - The signed artifact is uploaded to a designated bucket in Google Cloud Storage.
     - The build status (success/failure) and a link to the artifact are written to Firestore.
  6. **Notification:** The mobile client, which has been polling Firestore or listening for real-time updates, is notified that the build is complete and can download the artifact.

## 4. Data Management

### Cloud Firestore
- **`users` collection:** Stores user profiles, settings, and encrypted credentials for third-party services.
- **`projects` collection:** Stores metadata for each project, including its name, description, and a reference to its location in Cloud Storage.
- **`builds` collection:** Stores a log of all build jobs, their status, timestamps, and a link to the final artifact.

### Google Cloud Storage
- **Buckets:**
  - `project-source-files/`: Stores the raw source code for each user project.
  - `build-artifacts/`: Stores the compiled APKs and AABs generated by the CI/CD pipeline.
- **Lifecycle Policies:** Policies will be implemented to move older build artifacts to cheaper storage classes (e.g., Nearline or Coldline) to manage costs.

## 5. Backend Repository & CI/CD Structure

This section outlines the repository structure for the backend services and the CI/CD pipeline definitions. A monorepo approach is suitable for managing the backend services.

### Backend Monorepo Structure

```
.
├── services/
│   ├── bff/
│   │   ├── Dockerfile
│   │   ├── package.json
│   │   └── src/
│   │       ├── api/
│   │       │   ├── controllers/
│   │       │   └── routes/
│   │       ├── config/
│   │       ├── core/
│   │       │   └── services/
│   │       ├── middleware/
│   │       ├── types/
│   │       ├── utils/
│   │       └── index.ts
│   └── api-proxy/
│       ├── Dockerfile
│       ├── package.json
│       └── src/
│           ├── handlers/
│           ├── utils/
│           └── index.ts
├── terraform/
│   ├── cloud_run.tf
│   ├── firestore.tf
│   ├── storage.tf
│   └── variables.tf
├── user-project-template/
│   └── .github/
│       └── workflows/
│           └── android-build.yml
├── .gitignore
└── README.md
```

### User Project CI/CD Structure

This structure exists within each user's private project repository on GitHub, automatically managed by the PocketCode platform.

```
.
├── app/
│   ├── src/
│   └── build.gradle.kts
├── ... (user's project files)
└── .github/
    └── workflows/
        └── android-build.yml
```

- **`android-build.yml`:** This file contains the full definition of the CI/CD pipeline as described in Section 3c. It defines the jobs for building, signing, and uploading the Android application artifact.
